# 嵌入式系统Bootloader架构设计

**版本**: 1.0  
**日期**: 2026年1月  
**适用范围**: 工业级嵌入式系统平台

---

## 一屏摘要（可执行视图）
- 目标：工业级安全启动；<2s 启动；Bootloader <256KB；双分区回退；签名链全覆盖。
- 启动链：ROM/Stage0 → Stage1(汇编) → Stage2(HAL init) → Stage3(POST) → Stage4(Load+Verify) → Stage5(Handoff)。
- 分层：HAL → Driver → Core(Verify/Loader/Recovery) → Platform → Kernel handoff。
- 超时/喂狗：S1 100ms，S2 300ms，S3 500ms，S4 600ms，总 2000ms；各阶段喂狗点对齐 01_SYSTEM_PROPERTIES。
- 验收钩子：功能/性能用例见 TEST_STRATEGY；安全策略见 SECURITY_POLICY。

## 目录
1. [概述](#概述)
2. [功能需求](#功能需求)
3. [安全需求](#安全需求)
4. [系统架构](#系统架构)
5. [校验机制](#校验机制)
6. [启动流程](#启动流程)
7. [安全特性](#安全特性)
8. [性能指标](#性能指标)
9. [风险与缓解](#风险与缓解)
10. [验证与交付钩子](#验证与交付钩子)

---

## 阶段时序与上下文

| 阶段 | 内容 | 上下文限制 | 超时预算 | 看门狗喂狗点 |
|------|------|-----------|----------|---------------|
| Stage1 | 早期汇编初始化：禁中断、栈、BSS | 无中断；禁止阻塞 | 100ms (BOOT_STAGE1_MAX_TIME) | 退出前一次 |
| Stage2 | HAL 初始化：时钟、MMU、DRAM、IRQ、UART | 可使能中断；禁止动态分配 | 300ms (BOOT_STAGE2_MAX_TIME) | DRAM 完成、IRQ 完成 |
| Stage3 | POST 自检：内存、Flash、时钟、CRC自检 | 中断可用；日志有限 | 500ms (BOOT_STAGE3_MAX_TIME) | 每子项完成 |
| Stage4 | 加载与校验：分区→内核→CRC→SHA→签名→版本 | 禁止长阻塞；可分段校验 | 600ms (BOOT_STAGE4_MAX_TIME) | 读取完成、每校验完成 |
| Stage5 | handoff：设置参数→清理→跳内核入口 | 禁止中断；关闭缓存/或按平台 | 500ms (BOOT_STAGE5_MAX_TIME) | 跳转前一次 |

说明：超时预算来源于 01_SYSTEM_PROPERTIES；Stage1-5 总计 2000ms，需共用同一计时源；各阶段需最小日志并保证调试安全见 05_SECURITY_POLICY。

---

---

## 概述

### 定义
Bootloader是系统加电后运行的第一段代码，负责硬件初始化、系统自检、固件验证和内核启动。

### 核心目标
- **快速启动**: 最小化启动时间
- **可靠启动**: 异常情况下安全降级
- **安全启动**: 防止恶意代码执行
- **固件保护**: 确保系统完整性

---

## 功能需求

### 1. 硬件初始化
```
├── CPU初始化
│   ├── 时钟配置
│   ├── MMU/缓存配置
│   └── 中断向量表配置
├── 内存初始化
│   ├── DRAM初始化
│   ├── SRAM初始化
│   └── 内存检测
├── 外设初始化
│   ├── UART调试接口
│   ├── SPI/NAND Flash接口
│   ├── 网络接口（可选）
│   └── 看门狗
└── 电源管理初始化
    └── 稳压器配置
```

### 2. 系统自检（POST）
- 内存自检（Memtest）
- Flash存储器检测
- 时钟精度验证
- 看门狗功能测试

### 3. 固件加载和验证
- 从存储器读取内核镜像
- 完整性校验（CRC/SHA256）
- 数字签名验证
- 版本检查

### 4. 内核启动
- 传递启动参数（Device Tree、命令行）
- 跳转到内核入口点
- 清理Bootloader资源

### 5. 故障恢复
- 异常捕获和报告
- 降级启动（从备份固件启动）
- 恢复模式支持

---

## 安全需求

### 1. 固件完整性
- **校验算法**: CRC32/CRC64用于快速检测，SHA256用于安全性
- **覆盖范围**: 所有加载的代码和关键数据
- **存储位置**: 校验值存储在只读分区

### 2. 数字签名
- **算法**: RSA-2048或ECDSA-P256
- **验证流程**: 所有应用固件必须通过签名验证
- **公钥管理**: 公钥存储在OTP (One-Time Programmable)内存或安全区域

### 3. 安全启动链
```
Bootloader → 验证内核 → 启动内核 → 内核验证APP
```

### 4. 防护机制
- **回滚保护**: 防止降级到旧的漏洞版本
- **防篡改**: 监测固件修改
- **访问控制**: 限制对关键内存区域的访问

### 5. 调试安全
- **条件调试**: 仅在安全启动禁用时允许调试
- **调试认证**: 调试模式需要密钥授权
- **日志隐藏**: 删除生产版本中的调试输出

---

## 系统架构

### 分层架构

```
┌─────────────────────────────────┐
│     内核启动和系统初始化          │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│     应用固件加载和验证            │  ← 校验机制
│  - CRC/SHA256验证                │
│  - 数字签名验证                   │
│  - 版本检查                       │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│     存储器管理和访问              │
│  - Flash驱动                     │
│  - 分区管理                       │
│  - 坏块管理(NAND)                │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│     硬件驱动层                    │
│  - 外设驱动                       │
│  - 时钟管理                       │
│  - 中断处理                       │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│     硬件抽象层(HAL)              │
│  - CPU特定操作                    │
│  - 内存管理                       │
└─────────────────────────────────┘
```

### 模块设计

#### 模块1: 系统初始化模块 (CORE)
```c
├── boot.s          // 汇编启动代码
├── crt0.c          // C运行时初始化
├── clock.c         // 时钟配置
├── mmu.c           // 内存管理单元
└── irq.c           // 中断处理
```

#### 模块2: 存储访问模块 (STORAGE)
```c
├── flash.c         // Flash驱动
├── partition.c     // 分区表解析
├── nand_ecc.c      // ECC错误纠正
└── storage.c       // 存储抽象层
```

#### 模块3: 校验模块 (VERIFY)
```c
├── crc.c           // CRC计算
├── sha256.c        // SHA256算法
├── signature.c     // 数字签名验证
├── verify.c        // 验证主流程
└── rollback.h      // 回滚保护
```

#### 模块4: 固件加载模块 (LOADER)
```c
├── loader.c        // 加载管理
├── image.c         // 镜像格式解析
└── dtb.c           // Device Tree处理
```

#### 模块5: 工具模块 (UTILS)
```c
├── console.c       // 调试接口
├── gpio.c          // GPIO操作
├── watchdog.c      // 看门狗
└── utils.c         // 通用工具
```

---

## 校验机制

### 1. CRC32/64校验

**优点**: 快速、简单、适合检测随机错误  
**不适用**: 恶意篡改检测

```c
typedef struct {
    uint32_t crc32;
    uint32_t data_length;
    uint32_t reserved;
} CRC_Header;
```

**步骤**:
1. 计算固件的CRC值
2. 从存储器读取预期CRC值
3. 对比校验

### 2. SHA256校验

**优点**: 安全性高，难以碰撞  
**适用**: 检测任何修改

```c
typedef struct {
    uint8_t sha256[32];
    uint32_t data_length;
    uint8_t reserved[24];
} SHA_Header;
```

**步骤**:
1. 计算固件SHA256
2. 从OTP/ROM读取预期值
3. 对比校验

### 3. 数字签名验证

**算法**: RSA-2048 或 ECDSA-P256

```c
typedef struct {
    uint8_t signature[256];      // RSA-2048签名
    uint32_t data_length;
    uint8_t key_id;
    uint8_t algo;               // 0:RSA-2048, 1:ECDSA-P256
} Signature_Header;
```

**验证流程**:
```
固件数据 → SHA256计算 → RSA解密签名值 → 对比SHA256 → 验证结果
```

### 4. 多重校验策略

| 阶段 | 校验方式 | 失败行为 | 时间 |
|------|--------|--------|------|
| 1 | CRC32 | 快速检测错误 | ~1ms |
| 2 | SHA256 | 检测修改 | ~10ms |
| 3 | 数字签名 | 防止恶意替换 | ~50-100ms |
| 4 | 版本检查 | 防止回滚 | <1ms |

---

## 启动流程

### 详细流程图

```
电源启动
   │
   ▼
┌─────────────────────────────┐
│ 1. 第一阶段启动(汇编)         │
│ - 关闭中断                   │
│ - 初始化堆栈                 │
│ - 初始化全局数据             │
│ - 跳转到C代码               │
└──────────┬──────────────────┘
           │ (超时保护)
           ▼
┌─────────────────────────────┐
│ 2. 硬件初始化               │
│ - 时钟配置                   │
│ - MMU使能                    │
│ - DRAM初始化                │
│ - 看门狗初始化               │
└──────────┬──────────────────┘
           │ (失败→故障模式)
           ▼
┌─────────────────────────────┐
│ 3. 系统自检(POST)           │
│ - 内存检测                   │
│ - Flash检测                  │
│ - 时钟验证                   │
│ - CRC自检                    │
└──────────┬──────────────────┘
           │ (失败→恢复模式)
           ▼
┌─────────────────────────────┐
│ 4. 加载分区表               │
│ - 读取分区表                 │
│ - 验证分区完整性             │
│ - 定位内核分区               │
└──────────┬──────────────────┘
           │ (失败→备用分区)
           ▼
┌─────────────────────────────┐
│ 5. 加载并校验内核           │
│ - 从Flash读取内核           │
│ - CRC校验(快速)             │
│ - SHA256校验                │
│ - 签名验证                   │
│ - 版本检查                   │
└──────────┬──────────────────┘
           │ (失败→回滚)
           ▼
┌─────────────────────────────┐
│ 6. 加载Device Tree          │
│ - 读取DTB                   │
│ - 验证DTB                   │
│ - 应用DTB到内存             │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ 7. 最后检查和准备           │
│ - 禁用Bootloader MMU       │
│ - 清理临时数据              │
│ - 设置启动参数              │
└──────────┬──────────────────┘
           │
           ▼
┌─────────────────────────────┐
│ 8. 跳转到内核               │
│ - Call kernel entry point   │
│ - 内核接管系统              │
└─────────────────────────────┘
```

### 故障处理

```
验证失败
   │
   ├──► 尝试备用固件
   │      │
   │      ├──► 验证备用固件
   │      │      │
   │      │      ├──► 成功 → 启动备用固件
   │      │      │
   │      │      └──► 失败 → 继续
   │      │
   │      └──► 失败 → 继续
   │
   ├──► 进入恢复模式
   │      │
   │      ├──► 等待外部输入
   │      ├──► 支持固件升级
   │      └──► 诊断功能
   │
   └──► 紧急停止
         └──► LED指示、日志记录
```

---

## 安全特性

### 1. 安全启动链

```
OTP中的根密钥
   │
   ├──→ 验证Bootloader签名
   │      │
   │      ├──→ 失败: 无法启动系统
   │      │
   │      └──→ 成功: 继续
   │           │
   │           ├──→ 验证内核签名
   │           │      │
   │           │      ├──→ 失败: 尝试备用内核
   │           │      │
   │           │      └──→ 成功: 启动内核
   │           │
   │           └──→ 内核验证应用程序
   │                  └──→ 应用启动
```

### 2. 防回滚机制

```c
typedef struct {
    uint32_t current_version;      // 当前版本号
    uint32_t security_version;     // 最低安全版本
    uint32_t prev_version;         // 上一版本记录
    uint32_t timestamp;            // 时间戳
} Version_Info;

// 验证规则: new_version >= security_version
```

### 3. 计时器保护

```
检查点1 (100ms) → 检查点2 (300ms) → 检查点3 (1000ms)
如果看门狗未被清除 → 系统重启
```

### 4. 异常处理

```c
void exception_handler(uint32_t exception_type) {
    // 记录异常
    log_exception(exception_type);
    
    // 设置故障标志
    set_fault_flag();
    
    // 触发看门狗复位
    watchdog_force_reset();
}
```

### 5. 访问控制

- **OTP区域**: 仅读不写
- **内核分区**: 仅在安全启动禁用时可写
- **Recovery区域**: 受限写入
- **Bootloader代码**: 永远只读

---

## 性能指标

| 指标 | 目标值 | 备注 |
|------|-------|------|
| 启动时间(无验证) | < 500ms | 从复位到内核启动 |
| 启动时间(含验证) | < 2s | CRC+SHA256+签名 |
| 内存占用 | < 256KB | Bootloader代码+栈 |
| 校验速度 | > 50MB/s | SHA256计算速度 |
| 恢复时间 | < 5s | 降级到备份固件 |
| 看门狗周期 | 30s | 足以完成所有初始化 |

---

## 存储分区设计

```
┌─────────────────────────────────────┐
│ 0x00000000 - 0x0001FFFF             │
│ Bootloader (128KB)                  │
│ ├─ 代码段                           │
│ ├─ 数据段                           │
│ └─ CRC校验值                        │
├─────────────────────────────────────┤
│ 0x00020000 - 0x0003FFFF             │
│ Bootloader备份 (128KB)              │
├─────────────────────────────────────┤
│ 0x00040000 - 0x0007FFFF             │
│ 分区表 + 配置 (256KB)               │
├─────────────────────────────────────┤
│ 0x00080000 - 0x00CFFFFF             │
│ 内核分区 (C80000 bytes, ~12.5MB)    │
│ ├─ 镜像头                           │
│ ├─ 压缩内核                         │
│ ├─ SHA256                           │
│ └─ 签名                             │
├─────────────────────────────────────┤
│ 0x00D00000 - 0x017FFFFF             │
│ 内核备份分区 (11.0MB)               │
├─────────────────────────────────────┤
│ 0x01800000 - 0x1FFFFFFF             │
│ 应用程序分区 (~486MB)               │
├─────────────────────────────────────┤
│ 0xFFF00000 - 0xFFFFFFFF             │
│ OTP区域 (1MB)                       │
│ ├─ 根密钥                           │
│ ├─ 公钥                             │
│ ├─ 版本号                           │
│ └─ 芯片ID                           │
└─────────────────────────────────────┘
```

---

## 配置管理

### Bootloader配置文件

```ini
[SECURITY]
enable_secure_boot = 1
enable_signature_verify = 1
enable_rollback_protect = 1
min_kernel_version = 100
debug_mode = 0

[HARDWARE]
watchdog_timeout = 30000
dram_test_range = 0x80000000:0x90000000
console_baudrate = 115200

[BOOT]
default_kernel = 0
fallback_kernel = 1
boot_timeout = 10
splash_screen = 1

[PERFORMANCE]
enable_cache = 1
enable_mmu = 1
cpu_freq = 1200M
```

---

## 规范和标准

- **UEFI**: UEFI固件规范（参考）
- **U-Boot**: 开源Bootloader参考实现
- **GRUB2**: 高级启动管理器概念
- **TEE**: Trusted Execution Environment集成
- **安全标准**: Common Criteria EAL4+, FIPS 140-2

---

## 版本管理

| 阶段 | 版本 | 功能 | 计划 |
|------|------|------|------|
| 原型 | 0.1-0.5 | 基础启动、硬件初始化 | 第1-2周 |
| Alpha | 1.0 | CRC校验、简单错误处理 | 第3-4周 |
| Beta | 1.1-1.5 | SHA256、数字签名 | 第5-6周 |
| RC | 2.0 | 完整的安全启动链 | 第7-8周 |
| Release | 2.0.0 | 生产版本 | 第9周 |


## 风险与缓解
- 密钥泄露：密钥仅存 OTP/安全区；签名工具隔离；详见 SECURITY_POLICY。
- Flash 可靠性：双镜像 + 分区回退；NAND 坏块管理；定期校验。
- 超时/卡死：阶段超时预算 + 喂狗点；看门狗默认开启；启动关键路径不做动态分配。
- 性能不足：缓存/MMU 打开；IO 与哈希基准对齐 01_SYSTEM_PROPERTIES；必要时降级功能路径。
- 调试安全：生产默认关闭调试；调试需认证开关；日志裁剪。

## 验证与交付钩子
- 阶段验收：与 01_SYSTEM_PROPERTIES 的时间/性能指标绑定；阶段用例在 TEST_STRATEGY（boot_flow、recovery、perf）。
- 安全验收：签名链、回滚、防篡改由 SECURITY_POLICY 定义；镜像生成/签名/烧录流程需通过工具链校验。
- 产物检查：bootloader.bin 尺寸 <256KB；分区镜像由 mkimage+sign+mkpart 输出；哈希/签名元数据齐全。
- 调试开关：编译期/运行期开关必须在交付前关闭；发布包需附带公钥版本与最小安全版本号。

